name: DevSecOps SAST (Semgrep + CodeQL)

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  sast:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      security-events: write

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      # ==================================================
      # SEMGREP (CLI, scan ALL files in src/)
      # ==================================================
      - name: Run Semgrep on src directory
        run: |
          python3 -m pip install --upgrade pip
          pip install semgrep
          semgrep scan src \
            --config security/semgrep-rules \
            --config auto \
            --config p/owasp-top-ten \
            --json > semgrep.json || true

      - name: Upload Semgrep Report
        uses: actions/upload-artifact@v4
        with:
          name: semgrep-report
          path: semgrep.json

      # ==================================================
      # CODEQL – PYTHON
      # ==================================================
      - name: CodeQL Python Init
        if: hashFiles('src/**/*.py') != ''
        uses: github/codeql-action/init@v3
        with:
          languages: python
          build-mode: none
          queries: |
            codeql/python-queries
            ./security/codeql-queries

      - name: CodeQL Python Analyze
        if: hashFiles('src/**/*.py') != ''
        uses: github/codeql-action/analyze@v3

      # ==================================================
      # CODEQL – JAVASCRIPT
      # ==================================================
      - name: CodeQL JavaScript Init
        if: hashFiles('src/**/*.js') != ''
        uses: github/codeql-action/init@v3
        with:
          languages: javascript
          build-mode: none
          queries: |
            codeql/javascript-queries
            ./security/codeql-queries

      - name: CodeQL JavaScript Analyze
        if: hashFiles('src/**/*.js') != ''
        uses: github/codeql-action/analyze@v3

      # ==================================================
      # CODEQL – JAVA (MANUAL BUILD)
      # ==================================================
      - name: CodeQL Java Init
        if: hashFiles('src/main/java/**/*.java') != ''
        uses: github/codeql-action/init@v3
        with:
          languages: java
          build-mode: manual
          queries: |
            codeql/java-queries
            ./security/codeql-queries

      - name: Build Java
        if: hashFiles('src/main/java/**/*.java') != ''
        run: mvn clean compile -DskipTests

      - name: CodeQL Java Analyze
        if: hashFiles('src/main/java/**/*.java') != ''
        uses: github/codeql-action/analyze@v3

      # ==================================================
      # CODEQL – C / C++
      # ==================================================
      - name: CodeQL C/C++ Init
        if: hashFiles('src/**/*.c', 'src/**/*.cpp') != ''
        uses: github/codeql-action/init@v3
        with:
          languages: cpp
          build-mode: manual
          queries: |
            codeql/cpp-queries
            ./security/codeql-queries

      - name: Build C/C++
        if: hashFiles('src/**/*.c', 'src/**/*.cpp') != ''
        run: |
          mkdir -p build
          cd build
          cmake ..
          make

      - name: CodeQL C/C++ Analyze
        if: hashFiles('src/**/*.c', 'src/**/*.cpp') != ''
        uses: github/codeql-action/analyze@v3

      # ==================================================
      # CODEQL – GO
      # ==================================================
      - name: CodeQL Go Init
        if: hashFiles('src/**/*.go') != ''
        uses: github/codeql-action/init@v3
        with:
          languages: go
          build-mode: manual
          queries: |
            codeql/go-queries
            ./security/codeql-queries

      - name: Build Go
        if: hashFiles('src/**/*.go') != ''
        run: go build ./...

      - name: CodeQL Go Analyze
        if: hashFiles('src/**/*.go') != ''
        uses: github/codeql-action/analyze@v3
