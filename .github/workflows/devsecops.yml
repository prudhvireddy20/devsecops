name: DevSecOps SAST (Semgrep + CodeQL)

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  sast:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      security-events: write

    strategy:
      fail-fast: false
      matrix:
        include:
          # -------- INTERPRETED LANGUAGES --------
          - language: python
            build_mode: none
            build_cmd: ""

          - language: javascript
            build_mode: none
            build_cmd: ""

          # -------- COMPILED LANGUAGES --------
          - language: java
            build_mode: manual
            build_cmd: mvn clean compile -DskipTests

          - language: cpp
            build_mode: manual
            build_cmd: |
              mkdir -p build
              cd build
              cmake ..
              make

          - language: go
            build_mode: manual
            build_cmd: go build ./...

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      # ================= SEMGREP =================
      - name: Run Semgrep on src directory
        run: |
          pip install semgrep
          semgrep scan src \
            --config security/semgrep-rules \
            --config auto \
            --config p/owasp-top-ten \
            --json > semgrep.json || true

      - name: Upload Semgrep Report
        uses: github/upload-artifact@v4
        with:
          name: semgrep-report
          path: semgrep.json

      # ================= CODEQL =================
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: ${{ matrix.language }}
          build-mode: ${{ matrix.build_mode }}

      - name: Build project (manual mode only)
        if: matrix.build_mode == 'manual'
        run: |
          echo "Running build for ${{ matrix.language }}"
          ${{ matrix.build_cmd }}

      - name: Run CodeQL (built-in + custom queries)
        run: |
          codeql analyze \
            codeql-database \
            codeql/${{ matrix.language }}-queries \
            ./security/codeql-queries \
            --format=sarifv2 \
            --output=codeql-${{ matrix.language }}.sarif \
            --threads=0

      - name: Upload CodeQL SARIF
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: codeql-${{ matrix.language }}.sarif
