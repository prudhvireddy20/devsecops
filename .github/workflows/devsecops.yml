name: DevSecOps SAST (Semgrep + CodeQL)

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  sast:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      security-events: write

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      # ================= SEMGREP =================
      - name: Run Semgrep on src directory
        run: |
          python3 -m pip install --upgrade pip
          pip install semgrep
          semgrep scan src \
            --config security/semgrep-rules \
            --config auto \
            --config p/owasp-top-ten \
            --json > semgrep.json || true

      - name: Upload Semgrep Report
        uses: actions/upload-artifact@v4
        with:
          name: semgrep-report
          path: semgrep.json

      # ================= CODEQL : PYTHON =================
      - name: CodeQL Python Init
        if: hashFiles('src/**/*.py') != ''
        uses: github/codeql-action/init@v3
        with:
          languages: python
          build-mode: none

      - name: CodeQL Python Analyze
        if: hashFiles('src/**/*.py') != ''
        run: |
          codeql analyze \
            codeql-database \
            codeql/python-queries \
            ./security/codeql-queries \
            --format=sarifv2 \
            --output=codeql-python.sarif

      - name: Upload Python SARIF
        if: hashFiles('src/**/*.py') != ''
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: codeql-python.sarif

      # ================= CODEQL : JAVASCRIPT =================
      - name: CodeQL JavaScript Init
        if: hashFiles('src/**/*.js') != ''
        uses: github/codeql-action/init@v3
        with:
          languages: javascript
          build-mode: none

      - name: CodeQL JavaScript Analyze
        if: hashFiles('src/**/*.js') != ''
        run: |
          codeql analyze \
            codeql-database \
            codeql/javascript-queries \
            ./security/codeql-queries \
            --format=sarifv2 \
            --output=codeql-javascript.sarif

      - name: Upload JavaScript SARIF
        if: hashFiles('src/**/*.js') != ''
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: codeql-javascript.sarif

      # ================= CODEQL : JAVA =================
      - name: CodeQL Java Init
        if: hashFiles('src/main/java/**/*.java') != ''
        uses: github/codeql-action/init@v3
        with:
          languages: java
          build-mode: manual

      - name: Build Java
        if: hashFiles('src/main/java/**/*.java') != ''
        run: mvn clean compile -DskipTests

      - name: CodeQL Java Analyze
        if: hashFiles('src/main/java/**/*.java') != ''
        run: |
          codeql analyze \
            codeql-database \
            codeql/java-queries \
            ./security/codeql-queries \
            --format=sarifv2 \
            --output=codeql-java.sarif

      - name: Upload Java SARIF
        if: hashFiles('src/main/java/**/*.java') != ''
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: codeql-java.sarif

      # ================= CODEQL : C / C++ =================
      - name: CodeQL C/C++ Init
        if: hashFiles('src/**/*.c', 'src/**/*.cpp') != ''
        uses: github/codeql-action/init@v3
        with:
          languages: cpp
          build-mode: manual

      - name: Build C/C++
        if: hashFiles('src/**/*.c', 'src/**/*.cpp') != ''
        run: |
          mkdir -p build
          cd build
          cmake ..
          make

      - name: CodeQL C/C++ Analyze
        if: hashFiles('src/**/*.c', 'src/**/*.cpp') != ''
        run: |
          codeql analyze \
            codeql-database \
            codeql/cpp-queries \
            ./security/codeql-queries \
            --format=sarifv2 \
            --output=codeql-cpp.sarif

      - name: Upload C/C++ SARIF
        if: hashFiles('src/**/*.c', 'src/**/*.cpp') != ''
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: codeql-cpp.sarif

      # ================= CODEQL : GO =================
      - name: CodeQL Go Init
        if: hashFiles('src/**/*.go') != ''
        uses: github/codeql-action/init@v3
        with:
          languages: go
          build-mode: manual

      - name: Build Go
        if: hashFiles('src/**/*.go') != ''
        run: go build ./...

      - name: CodeQL Go Analyze
        if: hashFiles('src/**/*.go') != ''
        run: |
          codeql analyze \
            codeql-database \
            codeql/go-queries \
            ./security/codeql-queries \
            --format=sarifv2 \
            --output=codeql-go.sarif

      - name: Upload Go SARIF
        if: hashFiles('src/**/*.go') != ''
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: codeql-go.sarif
