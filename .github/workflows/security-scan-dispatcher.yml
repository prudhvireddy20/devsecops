# Centralized Security Scanner Workflow
# Runs on GitHub-hosted runners with container-based scanners
# Triggered via repository_dispatch from the DevSecOps Platform
# Scans the TARGET repository provided by the user, NOT this repository

name: Centralized Security Scan

on:
  repository_dispatch:
    types: [security-scan-request]
  workflow_dispatch:
    inputs:
      job_id:
        description: 'Scan Job ID'
        required: true
      repo_url:
        description: 'Repository URL to scan (required)'
        required: true
      branch:
        description: 'Branch to scan'
        required: false
        default: 'main'
      scanners:
        description: 'Comma-separated list of scanners'
        required: false
        default: 'semgrep,gitleaks,trivy,osv-scanner,syft'

env:
  JOB_ID: ${{ github.event.client_payload.job_id || github.event.inputs.job_id || github.run_id }}
  REPO_URL: ${{ github.event.client_payload.repo_url || github.event.inputs.repo_url }}
  BRANCH: ${{ github.event.client_payload.branch || github.event.inputs.branch || 'main' }}
  TARGET_DIR: /tmp/target-repo

jobs:
  setup:
    name: Setup Scan Environment
    runs-on: ubuntu-latest
    outputs:
      scanners: ${{ steps.detect.outputs.scanners }}
      has_semgrep: ${{ steps.detect.outputs.has_semgrep }}
      has_gitleaks: ${{ steps.detect.outputs.has_gitleaks }}
      has_trivy: ${{ steps.detect.outputs.has_trivy }}
      has_osv: ${{ steps.detect.outputs.has_osv }}
      has_syft: ${{ steps.detect.outputs.has_syft }}
      has_codeql: ${{ steps.detect.outputs.has_codeql }}
      has_noir: ${{ steps.detect.outputs.has_noir }}
      target_repo: ${{ steps.clone.outputs.repo_path }}
    steps:
      - name: Validate inputs
        run: |
          echo "Job ID: ${{ env.JOB_ID }}"
          echo "Target Repo URL: ${{ env.REPO_URL }}"
          echo "Branch: ${{ env.BRANCH }}"
          if [ -z "${{ env.REPO_URL }}" ]; then
            echo "ERROR: No repository URL provided!"
            exit 1
          fi

      - name: Clone target repository
        id: clone
        run: |
          echo "Cloning ${{ env.REPO_URL }} (branch: ${{ env.BRANCH }})"
          git clone --branch ${{ env.BRANCH }} --depth 1 ${{ env.REPO_URL }} ${{ env.TARGET_DIR }}
          echo "repo_path=${{ env.TARGET_DIR }}" >> $GITHUB_OUTPUT
          echo "Repository cloned successfully"
          ls -la ${{ env.TARGET_DIR }}

      - name: Detect scanners from payload
        id: detect
        run: |
          SCANNERS_RAW='${{ toJson(github.event.client_payload.scanners) }}'
          INPUT_SCANNERS='${{ github.event.inputs.scanners }}'
          
          if [ "$SCANNERS_RAW" = "null" ] || [ -z "$SCANNERS_RAW" ] || [ "$SCANNERS_RAW" = "[]" ]; then
            if [ -n "$INPUT_SCANNERS" ]; then
              SCANNERS=$(echo "$INPUT_SCANNERS" | jq -Rc 'split(",")')
            else
              SCANNERS='["semgrep","gitleaks","trivy","osv-scanner","syft"]'
            fi
          else
            SCANNERS=$(echo "$SCANNERS_RAW" | jq -c '.')
          fi
          
          echo "scanners=$SCANNERS" >> $GITHUB_OUTPUT
          echo "Scanners to run: $SCANNERS"
          
          echo "has_semgrep=$(echo "$SCANNERS" | jq -c 'contains(["semgrep"])')" >> $GITHUB_OUTPUT
          echo "has_gitleaks=$(echo "$SCANNERS" | jq -c 'contains(["gitleaks"])')" >> $GITHUB_OUTPUT
          echo "has_trivy=$(echo "$SCANNERS" | jq -c 'contains(["trivy"])')" >> $GITHUB_OUTPUT
          echo "has_osv=$(echo "$SCANNERS" | jq -c 'contains(["osv-scanner"])')" >> $GITHUB_OUTPUT
          echo "has_syft=$(echo "$SCANNERS" | jq -c 'contains(["syft"])')" >> $GITHUB_OUTPUT
          echo "has_codeql=$(echo "$SCANNERS" | jq -c 'contains(["codeql"])')" >> $GITHUB_OUTPUT
          echo "has_noir=$(echo "$SCANNERS" | jq -c 'contains(["owasp-noir"]) or contains(["noir"])')" >> $GITHUB_OUTPUT

      - name: Upload target repo as artifact
        uses: actions/upload-artifact@v4
        with:
          name: target-repo-${{ env.JOB_ID }}
          path: ${{ env.TARGET_DIR }}
          retention-days: 1

  semgrep:
    name: Semgrep SAST
    needs: setup
    if: needs.setup.outputs.has_semgrep == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Download target repo
        uses: actions/download-artifact@v4
        with:
          name: target-repo-${{ env.JOB_ID }}
          path: ./target

      - name: Run Semgrep
        uses: returntocorp/semgrep-action@v1
        with:
          config: auto
        env:
          SEMGREP_RULES: auto
        continue-on-error: true

      - name: Run Semgrep CLI
        run: |
          pip install semgrep
          cd ./target && semgrep scan --config auto --json --output ../semgrep-results.json . || true
          echo "Semgrep scan completed"

      - name: Upload Results
        uses: actions/upload-artifact@v4
        with:
          name: semgrep-results-${{ env.JOB_ID }}
          path: semgrep-results.json
          if-no-files-found: warn

  gitleaks:
    name: Gitleaks Secrets Detection
    needs: setup
    if: needs.setup.outputs.has_gitleaks == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Download target repo
        uses: actions/download-artifact@v4
        with:
          name: target-repo-${{ env.JOB_ID }}
          path: ./target

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          path: ./target
        continue-on-error: true

      - name: Run Gitleaks CLI
        run: |
          curl -sSL https://github.com/gitleaks/gitleaks/releases/download/v8.18.0/gitleaks_8.18.0_linux_x64.tar.gz | tar xz
          ./gitleaks detect --source=./target --report-path=gitleaks-results.json --report-format=json --exit-code 0 || true
          echo "Gitleaks scan completed"

      - name: Upload Results
        uses: actions/upload-artifact@v4
        with:
          name: gitleaks-results-${{ env.JOB_ID }}
          path: gitleaks-results.json
          if-no-files-found: warn

  trivy:
    name: Trivy Vulnerability Scanner
    needs: setup
    if: needs.setup.outputs.has_trivy == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Download target repo
        uses: actions/download-artifact@v4
        with:
          name: target-repo-${{ env.JOB_ID }}
          path: ./target

      - name: Run Trivy
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: './target'
          format: 'json'
          output: 'trivy-results.json'
        continue-on-error: true

      - name: Upload Results
        uses: actions/upload-artifact@v4
        with:
          name: trivy-results-${{ env.JOB_ID }}
          path: trivy-results.json
          if-no-files-found: warn

  osv-scanner:
    name: OSV Vulnerability Scanner
    needs: setup
    if: needs.setup.outputs.has_osv == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Download target repo
        uses: actions/download-artifact@v4
        with:
          name: target-repo-${{ env.JOB_ID }}
          path: ./target

      - name: Run OSV-Scanner
        uses: google/osv-scanner-action@v2.0.0
        with:
          scan-args: |-
            --json
            --output=osv-results.json
            -r
            ./target
        continue-on-error: true

      - name: Upload Results
        uses: actions/upload-artifact@v4
        with:
          name: osv-results-${{ env.JOB_ID }}
          path: osv-results.json
          if-no-files-found: warn

  syft:
    name: Syft SBOM Generation
    needs: setup
    if: needs.setup.outputs.has_syft == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Download target repo
        uses: actions/download-artifact@v4
        with:
          name: target-repo-${{ env.JOB_ID }}
          path: ./target

      - name: Generate SBOM with Syft
        uses: anchore/sbom-action@v0
        with:
          path: ./target
          format: json
          output-file: syft-sbom.json

      - name: Upload Results
        uses: actions/upload-artifact@v4
        with:
          name: syft-sbom-${{ env.JOB_ID }}
          path: syft-sbom.json
          if-no-files-found: warn

  owasp-noir:
    name: OWASP Noir Attack Surface
    needs: setup
    if: needs.setup.outputs.has_noir == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Download target repo
        uses: actions/download-artifact@v4
        with:
          name: target-repo-${{ env.JOB_ID }}
          path: ./target

      - name: Install and Run Noir
        run: |
          curl -sSL https://raw.githubusercontent.com/owasp-noir/noir/main/install.sh | bash
          ~/.noir/bin/noir -b ./target -o noir-results.json --format json || true
          echo "OWASP Noir scan completed"

      - name: Upload Results
        uses: actions/upload-artifact@v4
        with:
          name: noir-results-${{ env.JOB_ID }}
          path: noir-results.json
          if-no-files-found: warn

  codeql:
    name: CodeQL Analysis
    needs: setup
    if: needs.setup.outputs.has_codeql == 'true'
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      contents: read
    steps:
      - name: Download target repo
        uses: actions/download-artifact@v4
        with:
          name: target-repo-${{ env.JOB_ID }}
          path: ./target

      - name: Detect Languages
        id: detect-languages
        run: |
          cd ./target
          LANGS=""
          if find . -name "*.py" -type f | head -1 | grep -q .; then LANGS="$LANGS,python"; fi
          if find . -name "*.js" -o -name "*.ts" -type f | head -1 | grep -q .; then LANGS="$LANGS,javascript"; fi
          if find . -name "*.java" -type f | head -1 | grep -q .; then LANGS="$LANGS,java"; fi
          if find . -name "*.go" -type f | head -1 | grep -q .; then LANGS="$LANGS,go"; fi
          LANGS="${LANGS#,}"
          if [ -z "$LANGS" ]; then LANGS="javascript"; fi
          echo "languages=$LANGS" >> $GITHUB_OUTPUT
          echo "Detected languages: $LANGS"

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: ${{ steps.detect-languages.outputs.languages }}
          source-root: ./target

      - name: Autobuild
        uses: github/codeql-action/autobuild@v3

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          output: codeql-results

      - name: Upload Results
        uses: actions/upload-artifact@v4
        with:
          name: codeql-results-${{ env.JOB_ID }}
          path: codeql-results
          if-no-files-found: warn

  collect-results:
    name: Collect and Report Results
    needs: [semgrep, gitleaks, trivy, osv-scanner, syft, codeql, owasp-noir]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Download all scan artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./all-results
          pattern: '*-results-*'

      - name: List results
        run: |
          echo "=== Scan Results for Job: ${{ env.JOB_ID }} ==="
          echo "Target Repository: ${{ env.REPO_URL }}"
          echo "Branch: ${{ env.BRANCH }}"
          echo ""
          find ./all-results -type f -name "*.json" | while read f; do
            echo "--- $(basename $f) ---"
            head -100 "$f" 2>/dev/null || echo "File empty or not found"
            echo ""
          done

      - name: Create summary
        run: |
          echo "## Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Job ID:** ${{ env.JOB_ID }}" >> $GITHUB_STEP_SUMMARY
          echo "**Target Repository:** ${{ env.REPO_URL }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ env.BRANCH }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Scan Results" >> $GITHUB_STEP_SUMMARY
          for dir in ./all-results/*/; do
            if [ -d "$dir" ]; then
              name=$(basename "$dir")
              echo "- âœ… $name" >> $GITHUB_STEP_SUMMARY
            fi
          done
