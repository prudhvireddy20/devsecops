# Centralized Security Scanner Workflow
# Runs on GitHub-hosted runners with container-based scanners
# Triggered via repository_dispatch from the DevSecOps Platform

name: Centralized Security Scan

on:
  repository_dispatch:
    types: [security-scan-request]
  workflow_dispatch:
    inputs:
      job_id:
        description: 'Scan Job ID'
        required: true
      repo_url:
        description: 'Repository URL to scan'
        required: false
      branch:
        description: 'Branch to scan'
        required: false
        default: 'main'
      scanners:
        description: 'Comma-separated list of scanners'
        required: false
        default: 'semgrep,gitleaks,trivy,osv-scanner,syft'

env:
  JOB_ID: ${{ github.event.client_payload.job_id || github.event.inputs.job_id || github.run_id }}
  REPO_URL: ${{ github.event.client_payload.repo_url || github.event.inputs.repo_url }}
  BRANCH: ${{ github.event.client_payload.branch || github.event.inputs.branch || 'main' }}

jobs:
  setup:
    name: Setup Scan Environment
    runs-on: ubuntu-latest
    outputs:
      scanners: ${{ steps.detect.outputs.scanners }}
      has_semgrep: ${{ steps.detect.outputs.has_semgrep }}
      has_gitleaks: ${{ steps.detect.outputs.has_gitleaks }}
      has_trivy: ${{ steps.detect.outputs.has_trivy }}
      has_osv: ${{ steps.detect.outputs.has_osv }}
      has_syft: ${{ steps.detect.outputs.has_syft }}
      has_codeql: ${{ steps.detect.outputs.has_codeql }}
      has_noir: ${{ steps.detect.outputs.has_noir }}
    steps:
      - name: Detect scanners from payload
        id: detect
        run: |
          # Get scanners from payload or input
          SCANNERS_RAW='${{ toJson(github.event.client_payload.scanners) }}'
          INPUT_SCANNERS='${{ github.event.inputs.scanners }}'
          
          # Compact JSON to single line and handle defaults
          if [ "$SCANNERS_RAW" = "null" ] || [ -z "$SCANNERS_RAW" ] || [ "$SCANNERS_RAW" = "[]" ]; then
            if [ -n "$INPUT_SCANNERS" ]; then
              # Convert comma-separated to JSON array
              SCANNERS=$(echo "$INPUT_SCANNERS" | jq -Rc 'split(",")')
            else
              SCANNERS='["semgrep","gitleaks","trivy","osv-scanner","syft"]'
            fi
          else
            # Compact to single line
            SCANNERS=$(echo "$SCANNERS_RAW" | jq -c '.')
          fi
          
          echo "scanners=$SCANNERS" >> $GITHUB_OUTPUT
          echo "Scanners to run: $SCANNERS"
          
          # Set individual scanner flags using compact JSON
          echo "has_semgrep=$(echo "$SCANNERS" | jq -c 'contains(["semgrep"])')" >> $GITHUB_OUTPUT
          echo "has_gitleaks=$(echo "$SCANNERS" | jq -c 'contains(["gitleaks"])')" >> $GITHUB_OUTPUT
          echo "has_trivy=$(echo "$SCANNERS" | jq -c 'contains(["trivy"])')" >> $GITHUB_OUTPUT
          echo "has_osv=$(echo "$SCANNERS" | jq -c 'contains(["osv-scanner"])')" >> $GITHUB_OUTPUT
          echo "has_syft=$(echo "$SCANNERS" | jq -c 'contains(["syft"])')" >> $GITHUB_OUTPUT
          echo "has_codeql=$(echo "$SCANNERS" | jq -c 'contains(["codeql"])')" >> $GITHUB_OUTPUT
          echo "has_noir=$(echo "$SCANNERS" | jq -c 'contains(["owasp-noir"]) or contains(["noir"])')" >> $GITHUB_OUTPUT

  semgrep:
    name: Semgrep SAST
    needs: setup
    if: needs.setup.outputs.has_semgrep == 'true'
    runs-on: ubuntu-latest
    container:
      image: returntocorp/semgrep:latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run Semgrep
        run: |
          semgrep scan --config auto --json --output $GITHUB_WORKSPACE/semgrep-results.json . || true
          echo "Semgrep scan completed"

      - name: Upload Results
        uses: actions/upload-artifact@v4
        with:
          name: semgrep-results-${{ env.JOB_ID }}
          path: ${{ github.workspace }}/semgrep-results.json
          if-no-files-found: warn

  gitleaks:
    name: Gitleaks Secrets Detection
    needs: setup
    if: needs.setup.outputs.has_gitleaks == 'true'
    runs-on: ubuntu-latest
    container:
      image: zricethezav/gitleaks:latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Gitleaks
        run: |
          gitleaks detect --source=. --report-path=$GITHUB_WORKSPACE/gitleaks-results.json --report-format=json --exit-code 0 || true
          echo "Gitleaks scan completed"

      - name: Upload Results
        uses: actions/upload-artifact@v4
        with:
          name: gitleaks-results-${{ env.JOB_ID }}
          path: ${{ github.workspace }}/gitleaks-results.json
          if-no-files-found: warn

  trivy:
    name: Trivy Vulnerability Scanner
    needs: setup
    if: needs.setup.outputs.has_trivy == 'true'
    runs-on: ubuntu-latest
    container:
      image: aquasec/trivy:latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run Trivy FS Scan
        run: |
          trivy fs --format json --output $GITHUB_WORKSPACE/trivy-results.json . || true
          echo "Trivy scan completed"

      - name: Upload Results
        uses: actions/upload-artifact@v4
        with:
          name: trivy-results-${{ env.JOB_ID }}
          path: ${{ github.workspace }}/trivy-results.json
          if-no-files-found: warn

  osv-scanner:
    name: OSV Vulnerability Scanner
    needs: setup
    if: needs.setup.outputs.has_osv == 'true'
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/google/osv-scanner:latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run OSV-Scanner
        run: |
          /osv-scanner --json -r . > $GITHUB_WORKSPACE/osv-results.json 2>&1 || true
          echo "OSV-Scanner completed"

      - name: Upload Results
        uses: actions/upload-artifact@v4
        with:
          name: osv-results-${{ env.JOB_ID }}
          path: ${{ github.workspace }}/osv-results.json
          if-no-files-found: warn

  syft:
    name: Syft SBOM Generation
    needs: setup
    if: needs.setup.outputs.has_syft == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Generate SBOM with Syft
        uses: anchore/sbom-action@v0
        with:
          path: .
          format: json
          output-file: syft-sbom.json

      - name: Upload Results
        uses: actions/upload-artifact@v4
        with:
          name: syft-sbom-${{ env.JOB_ID }}
          path: syft-sbom.json
          if-no-files-found: warn

  owasp-noir:
    name: OWASP Noir Attack Surface
    needs: setup
    if: needs.setup.outputs.has_noir == 'true'
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/owasp-noir/noir:main
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run Noir
        run: |
          noir -b . -o $GITHUB_WORKSPACE/noir-results.json --format json || true
          echo "OWASP Noir scan completed"

      - name: Upload Results
        uses: actions/upload-artifact@v4
        with:
          name: noir-results-${{ env.JOB_ID }}
          path: ${{ github.workspace }}/noir-results.json
          if-no-files-found: warn

  codeql:
    name: CodeQL Analysis
    needs: setup
    if: needs.setup.outputs.has_codeql == 'true'
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Detect Languages
        id: detect-languages
        run: |
          # Detect languages in the repository
          LANGS=""
          if find . -name "*.py" -type f | head -1 | grep -q .; then LANGS="$LANGS,python"; fi
          if find . -name "*.js" -o -name "*.ts" -type f | head -1 | grep -q .; then LANGS="$LANGS,javascript"; fi
          if find . -name "*.java" -type f | head -1 | grep -q .; then LANGS="$LANGS,java"; fi
          if find . -name "*.go" -type f | head -1 | grep -q .; then LANGS="$LANGS,go"; fi
          if find . -name "*.cs" -type f | head -1 | grep -q .; then LANGS="$LANGS,csharp"; fi
          if find . -name "*.cpp" -o -name "*.c" -o -name "*.h" -type f | head -1 | grep -q .; then LANGS="$LANGS,cpp"; fi
          if find . -name "*.rb" -type f | head -1 | grep -q .; then LANGS="$LANGS,ruby"; fi
          
          # Remove leading comma and default to javascript if empty
          LANGS="${LANGS#,}"
          if [ -z "$LANGS" ]; then LANGS="javascript"; fi
          
          echo "languages=$LANGS" >> $GITHUB_OUTPUT
          echo "Detected languages: $LANGS"

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: ${{ steps.detect-languages.outputs.languages }}

      - name: Autobuild
        uses: github/codeql-action/autobuild@v3

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          output: ${{ github.workspace }}/codeql-results

      - name: Upload Results
        uses: actions/upload-artifact@v4
        with:
          name: codeql-results-${{ env.JOB_ID }}
          path: ${{ github.workspace }}/codeql-results
          if-no-files-found: warn

  collect-results:
    name: Collect and Report Results
    needs: [semgrep, gitleaks, trivy, osv-scanner, syft, codeql, owasp-noir]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./all-results

      - name: List results
        run: |
          echo "=== Scan Results for Job: ${{ env.JOB_ID }} ==="
          find ./all-results -type f -name "*.json" | while read f; do
            echo "--- $(basename $f) ---"
            head -50 "$f" 2>/dev/null || echo "File empty or not found"
          done

      - name: Create summary
        run: |
          echo "## Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Job ID:** ${{ env.JOB_ID }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Scanners Executed" >> $GITHUB_STEP_SUMMARY
          for dir in ./all-results/*/; do
            if [ -d "$dir" ]; then
              echo "- âœ… $(basename $dir)" >> $GITHUB_STEP_SUMMARY
            fi
          done

      # Uncomment to send results back to platform
      # - name: Report to DevSecOps Platform
      #   if: env.JOB_ID != ''
      #   run: |
      #     curl -X POST "https://your-platform/api/results/${{ env.JOB_ID }}" \
      #       -H "Content-Type: application/json" \
      #       -d @./all-results/combined.json
