version: '3.8'

services:
  api:
    build:
      context: ./platform/api
      dockerfile: Dockerfile
    ports:
      - "5000:5000"
    environment:
      - UPLOAD_DIR=/app/uploads
      - RESULTS_DIR=/app/results
      - STORAGE_DIR=/app/storage
      - STORAGE_TYPE=local
    volumes:
      - ./platform/api:/app
      - ./platform/dispatcher:/app/../dispatcher:ro  # Mount dispatcher scripts
      - scan-uploads:/app/uploads
      - scan-results:/app/results
      - scan-storage:/app/storage
      - /var/run/docker.sock:/var/run/docker.sock  # Mount Docker socket for Docker-in-Docker
    working_dir: /app
    depends_on:
      - minio
    networks:
      - scan-network
    privileged: true  # Required for Docker-in-Docker

  dashboard:
    image: nginx:alpine
    ports:
      - "8080:80"
    volumes:
      - ./platform/dashboard:/usr/share/nginx/html
    networks:
      - scan-network

  minio:
    image: minio/minio:latest
    ports:
      - "9000:9000"
      - "9001:9001"
    environment:
      - MINIO_ROOT_USER=minioadmin
      - MINIO_ROOT_PASSWORD=minioadmin
    command: server /data --console-address ":9001"
    volumes:
      - minio-data:/data
    networks:
      - scan-network

  # Optional: Local S3-compatible storage client
  mc:
    image: minio/mc:latest
    entrypoint: /bin/sh
    command: -c "sleep 5 && mc alias set local http://minio:9000 minioadmin minioadmin && mc mb local/security-scan-results || true"
    depends_on:
      - minio
    networks:
      - scan-network

volumes:
  scan-uploads:
  scan-results:
  scan-storage:
  minio-data:

networks:
  scan-network:
    driver: bridge
